{
  "emr_config": {
    "Name": "divina-cluster-${VISION_ID}",
    "ReleaseLabel": "emr-6.2.0",
    "Instances": {
      "KeepJobFlowAliveWhenNoSteps": false,
      "TerminationProtected": false,
      "InstanceGroups": [
        {
          "InstanceRole": "TASK",
          "InstanceType": "c4.xlarge",
          "InstanceCount": 3
        },
        {
          "InstanceRole": "MASTER",
          "InstanceType": "c4.xlarge",
          "InstanceCount": 1
        },
        {
          "InstanceRole": "CORE",
          "InstanceType": "c4.xlarge",
          "InstanceCount": 1
        }
      ],
      "Ec2KeyName": "${EC2_KEYNAME}"
    },
    "LogUri": "s3://coysu-divina-prototype-visions/coysu-divina-prototype-${VISION_ID}/logs/emr_logs",
    "Applications": [
      {
        "Name": "Spark"
      }
    ],
    "Steps": [
      {
        "Name": "setup_state_pusher",
        "ActionOnFailure": "${EMR_ON_FAILURE}",
        "HadoopJarStep": {
          "Jar": "command-runner.jar",
          "Args": [
            "state-pusher-script"
          ]
        }
      },
      {
        "Name": "setup_s3_sync_scripts",
        "ActionOnFailure": "${EMR_ON_FAILURE}",
        "HadoopJarStep": {
          "Jar": "command-runner.jar",
          "Args": [
            "aws",
            "s3",
            "sync",
            "s3://coysu-divina-prototype-visions/coysu-divina-prototype-${VISION_ID}/spark_scripts",
            "/home/hadoop/spark_scripts"
          ]
        }
      },
      {
        "Name": "setup_s3_sync_data",
        "ActionOnFailure": "${EMR_ON_FAILURE}",
        "HadoopJarStep": {
          "Jar": "command-runner.jar",
          "Args": [
            "aws",
            "s3",
            "cp",
            "s3://coysu-divina-prototype-visions/coysu-divina-prototype-${VISION_ID}/data_definition.json",
            "/home/hadoop/data_definition.json"
          ]
        }
      },
      {
        "Name": "vision_script",
        "ActionOnFailure": "${EMR_ON_FAILURE}",
        "HadoopJarStep": {
          "Jar": "command-runner.jar",
          "Args": [
            "spark-submit",
            "/home/hadoop/spark_scripts/predict.py"
          ]
        }
      },
      {
        "Name": "validation_script",
        "ActionOnFailure": "${EMR_ON_FAILURE}",
        "HadoopJarStep": {
          "Jar": "command-runner.jar",
          "Args": [
            "spark-submit",
            "/home/hadoop/spark_scripts/validate.py"
          ]
        }
      }
    ],
    "Configurations": [
      {
        "Classification": "spark-env",
        "Configurations": [
          {
            "Classification": "export",
            "Properties": {
              "PYSPARK_PYTHON": "/usr/bin/python3",
              "VISION_ID": "${VISION_ID}"
            }
          }
        ]
      }
    ],
    "VisibleToAllUsers": true,
    "JobFlowRole": "${WORKER_PROFILE}",
    "ServiceRole": "${DRIVER_ROLE}"
  }
}